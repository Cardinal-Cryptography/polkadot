name: Release - Publish RC Container image
# see https://github.com/paritytech/release-engineering/issues/97#issuecomment-1651372277

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: 'Release ID'
        required: true
        type: string
      registry:
        description: "Container registry"
        required: true
        type: string
        default: docker.io/parity

env:
  RELEASE_ID: ${{ inputs.release_id }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # paritytech
  OWNER: ${{ github.repository_owner }}
  # polkadot
  REPO: ${{ github.event.repository.name }}

jobs:
  build-containers:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        binary: ["polkadot", "staking-miner"]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Source common lib
        run: |
          . ./scripts/ci/common/lib.sh

      - name: Fetch all artifacts
        run: |
          fetch_release_artifacts

      - name: Check ${{ matrix.binary }}
        working-directory: ./artifacts
        run: |
          echo "Checking binary ${{ matrix.binary }}"
          check_sha256 ${{ matrix.binary }}
          check_gpg ${{ matrix.binary }}

      - name: Build Injected Container image for ${{ matrix.binary }}
        run: |
          echo "Building container for ${{ matrix.binary }}"

      - name: Push Container image
        env:
          IMAGE: ${{ inputs.registry }}/${{ matrix.binary }}
        run: |
          echo "TODO Pushing image to $IMAGE"
